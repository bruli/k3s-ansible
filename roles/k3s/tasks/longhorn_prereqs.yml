- name: Longhorn prerequisites (iSCSI) for all nodes
  become: true
  tags: [longhorn, prereqs]
  block:
    - name: Update APT index (safe)
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install open-iscsi and nfs-common
      ansible.builtin.apt:
        name:
          - open-iscsi
          - nfs-common
        state: present

    - name: Ensure iscsid service is enabled and running
      ansible.builtin.systemd:
        name: iscsid
        enabled: true
        state: started

    - name: (Optional) Enable open-iscsi service if it exists
      ansible.builtin.systemd:
        name: open-iscsi
        enabled: true
        state: started
      register: openiscsi_unit
      failed_when: false
      changed_when: openiscsi_unit is changed

    - name: Load iscsi_tcp kernel module now and persist across reboots
      community.general.modprobe:
        name: iscsi_tcp
        state: present
        persistent: present

    - name: Verify iscsi_tcp module is loaded
      ansible.builtin.command: lsmod
      register: lsmod_output
      changed_when: false

    - name: Show iscsi_tcp match in lsmod output
      ansible.builtin.debug:
        msg: "{{ lsmod_output.stdout_lines | select('search', '^iscsi_tcp\\s') | list }}"
