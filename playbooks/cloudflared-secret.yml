---
- name: Crear o actualitzar el secret de Cloudflared amb el token de l'entorn
  hosts: localhost
  gather_facts: false

  vars:
    kubeconfig_path: "{{ lookup('env', 'KUBECONFIG') | default('~/.kube/config', true) }}"
    cloudflare_namespace: "networking"
    secret_name: "cloudflared-credentials"
    cloudflare_token: "{{ lookup('env', 'CLOUDFLARE_TOKEN') | default('', true) }}"

  tasks:
    - name: Comprovar que CLOUDFLARE_TOKEN est√† definit
      assert:
        that: cloudflare_token != ''
        fail_msg: >
          ‚ùå La variable d'entorn CLOUDFLARE_TOKEN no est√† definida.
          Exporta-la abans d'executar el playbook:
          export CLOUDFLARE_TOKEN=<el_teu_token>
      tags: check

    - name: Assegurar que el namespace existeix
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ cloudflare_namespace }}"
      tags: ns

    - name: Crear o actualitzar el secret de Cloudflared
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: "{{ secret_name }}"
            namespace: "{{ cloudflare_namespace }}"
          type: Opaque
          stringData:
            token: "{{ cloudflare_token }}"
      tags: secret

    - name: Confirmar la creaci√≥ o actualitzaci√≥
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig_path }}"
        kind: Secret
        namespace: "{{ cloudflare_namespace }}"
        name: "{{ secret_name }}"
      register: cf_secret

    - name: Mostrar resum
      debug:
        msg:
          - "‚úÖ Secret '{{ secret_name }}' creat/actualitzat a namespace '{{ cloudflare_namespace }}'"
          - "üìÖ Data de creaci√≥: {{ cf_secret.resources[0].metadata.creationTimestamp }}"
